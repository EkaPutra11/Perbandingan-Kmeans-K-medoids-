{% extends 'base.html' %}

{% block title %}KMeans Preprocessing - Arwana Sales Analytics{% endblock %}

{% block content %}
<style>
    .preprocessing-header {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 10px;
    }
    
    .preprocessing-header h1 {
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .preprocessing-header p {
        margin-bottom: 0;
        opacity: 0.95;
    }
    
    .control-card {
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .control-card .card-header {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        border: none;
        padding: 1.2rem;
    }
    
    .control-card .card-header h5 {
        font-weight: 600;
        margin: 0;
    }
    
    .form-control {
        border-radius: 6px;
        border: 1px solid #dee2e6;
        padding: 0.7rem;
    }
    
    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .metrics-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .metric-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        border-left: 4px solid #0d6efd;
    }
    
    .metric-card h6 {
        color: #6c757d;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
    }
    
    .metric-card h3 {
        color: #0d6efd;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .metric-card small {
        color: #6c757d;
        font-size: 0.8rem;
    }
    
    .results-card {
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
        margin-bottom: 2rem;
        overflow: hidden;
    }
    
    .results-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #0d6efd;
        padding: 1.2rem;
    }
    
    .results-card .card-header h5 {
        font-weight: 600;
        margin: 0;
        color: #333;
    }
    
    .nav-tabs .nav-link {
        color: #6c757d;
        border: none;
        border-bottom: 3px solid transparent;
        font-weight: 500;
        margin-bottom: -2px;
    }
    
    .nav-tabs .nav-link:hover {
        color: #0d6efd;
        border-bottom-color: #0d6efd;
    }
    
    .nav-tabs .nav-link.active {
        color: #0d6efd;
        background-color: transparent;
        border-bottom-color: #0d6efd;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin: 1rem 0;
    }
    
    .sidebar-card {
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .sidebar-card.info-card {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        color: white;
    }
    
    .sidebar-card.legend-card {
        background: linear-gradient(135deg, #ffc107 0%, #ffb700 100%);
        color: #333;
    }
    
    .sidebar-card .card-header {
        background: rgba(0,0,0,0.1);
        border: none;
        padding: 1rem;
    }
    
    .sidebar-card .card-header h5 {
        font-weight: 600;
        margin: 0;
    }
    
    .sidebar-card .card-body {
        padding: 1rem;
    }
    
    .sidebar-card p {
        margin-bottom: 0.7rem;
        font-size: 0.9rem;
    }
    
    .sidebar-card ul {
        padding-left: 1.2rem;
        margin-bottom: 0;
    }
    
    .sidebar-card li {
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .btn-primary-large {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 6px;
        border: none;
    }
    
    .status-success .spinner-border {
        color: #198754 !important;
    }
    
    .status-loading .spinner-border {
        color: #0d6efd !important;
    }

    /* === NEW STYLES FOR ITERATIONS === */
    .iteration-section {
        margin-top: 2rem;
    }

    .iteration-card {
        border: 2px solid #e9ecef;
        border-left: 5px solid #0d6efd;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .iteration-header {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        color: white;
        padding: 1rem 1.5rem;
        font-weight: 600;
        font-size: 1rem;
    }

    .iteration-content {
        padding: 1.5rem;
    }

    .centroid-section {
        margin-bottom: 2rem;
    }

    .centroid-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
        font-size: 0.95rem;
    }

    .centroid-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .centroid-box {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 1rem;
        text-align: center;
    }

    .centroid-label {
        display: inline-block;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 0.75rem;
        color: white;
    }

    .centroid-label.c0 {
        background: linear-gradient(135deg, #198754 0%, #157347 100%);
    }

    .centroid-label.c1 {
        background: linear-gradient(135deg, #ffc107 0%, #ffb700 100%);
        color: #333;
    }

    .centroid-label.c2 {
        background: linear-gradient(135deg, #dc3545 0%, #bb2d3b 100%);
    }

    .centroid-value {
        font-weight: 600;
        color: #0d6efd;
        font-size: 1.1rem;
        margin-bottom: 0.3rem;
    }

    .centroid-label-small {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
    }

    .distance-section {
        margin-bottom: 1rem;
    }

    .distance-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
        font-size: 0.95rem;
    }

    .distance-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        background: white;
    }

    .distance-table thead {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .distance-table th {
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        color: #333;
        border: 1px solid #dee2e6;
    }

    .distance-table td {
        padding: 0.75rem;
        border: 1px solid #dee2e6;
    }

    .distance-table tbody tr:nth-child(even) {
        background: #f8f9fa;
    }

    .distance-table tbody tr:hover {
        background: #e7f1ff;
    }

    .distance-value {
        font-weight: 500;
        text-align: right;
    }

    .cluster-badge {
        display: inline-block;
        padding: 0.3rem 0.7rem;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.8rem;
        color: white;
    }

    .cluster-badge.c0 {
        background: #198754;
    }

    .cluster-badge.c1 {
        background: #ffc107;
        color: #333;
    }

    .cluster-badge.c2 {
        background: #dc3545;
    }

    .convergence-badge {
        display: inline-block;
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        margin-top: 1rem;
    }

    .final-results-section {
        margin-top: 2rem;
    }

    .final-results-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
        background: white;
        margin-bottom: 1.5rem;
    }

    .final-results-table thead {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        color: white;
    }

    .final-results-table th {
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        border: 1px solid #dee2e6;
    }

    .final-results-table td {
        padding: 0.75rem;
        border: 1px solid #dee2e6;
    }

    .final-results-table tbody tr:nth-child(even) {
        background: #f8f9fa;
    }

    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .summary-stat {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 6px;
        padding: 1rem;
        text-align: center;
        border: 1px solid #dee2e6;
    }

    .summary-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0d6efd;
        margin-bottom: 0.5rem;
    }

    .summary-stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        font-weight: 500;
    }
</style>

<div class="preprocessing-header">
    <div class="container">
        <h1>üìä K-Means Clustering</h1>
        <p>Manual K-Means implementation dengan pengukuran kualitas Davies-Bouldin Index</p>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-8">
            <!-- Clustering Form -->
            <div class="card control-card">
                <div class="card-header">
                    <h5>‚öôÔ∏è Konfigurasi Clustering</h5>
                </div>
                <div class="card-body">
                    <form id="kmeans-form" method="POST">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="k-value" class="form-label fw-500">Jumlah Cluster (K)</label>
                                <input type="number" class="form-control" id="k-value" name="k" value="3" min="2" max="10">
                                <small class="text-muted">Tentukan jumlah cluster yang diinginkan (2-10)</small>
                            </div>
                            <div class="col-md-6 d-flex align-items-end gap-2">
                                <button type="button" class="btn btn-primary btn-primary-large flex-grow-1" id="run-btn">
                                    <span id="btn-text">‚ñ∂Ô∏è Jalankan Clustering</span>
                                    <span id="spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
                                </button>
                                <button type="button" class="btn btn-danger" id="reset-btn">
                                    üîÑ Reset
                                </button>
                            </div>
                        </div>
                    </form>
                    <div id="alert-container" class="mt-3"></div>
                    
                    <!-- Clustering Information (Read-only) -->
                    <div id="clustering-info" class="mt-3 d-none">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label fw-500 text-secondary">Jumlah Cluster</label>
                                <input type="text" class="form-control" id="display-k" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-500 text-secondary">Jumlah Iterasi</label>
                                <input type="text" class="form-control" id="display-iterations" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Display -->
                    <div id="status-container" class="mt-3 d-none">
                        <div class="alert alert-info status-loading mb-0">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-3" role="status" id="status-spinner">
                                    <span class="visually-hidden">Processing...</span>
                                </div>
                                <div>
                                    <strong id="status-text">Processing...</strong>
                                    <p id="status-message" class="mb-0 mt-1 small"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metrics Display -->
            <div id="metrics-container" class="d-none">
                <div class="metrics-row">
                    <div class="metric-card">
                        <h6>Inertia</h6>
                        <h3 id="inertia-value">-</h3>
                        <small>Jumlah kuadrat jarak ke centroid</small>
                    </div>
                    <div class="metric-card" style="border-left-color: #198754;">
                        <h6>Davies-Bouldin Index</h6>
                        <h3 id="dbi-value" style="color: #198754;">-</h3>
                        <small>Semakin rendah semakin baik</small>
                    </div>
                </div>
            </div>

            <!-- Analysis Breakdown - REMOVED -->
            <!-- Chart - REMOVED -->

            <!-- Iterations Visualization -->
            <div id="iterations-container" class="d-none iteration-section">
                <div class="results-card">
                    <div class="card-header">
                        <h5>üìä Proses K-Means Iterasi Detail</h5>
                    </div>
                    <div class="card-body">
                        <div id="iterations-list"></div>
                    </div>
                </div>
            </div>

            <!-- Final Results Section -->
            <div id="final-results-container" class="d-none final-results-section">
                <div class="results-card">
                    <div class="card-header">
                        <h5>‚úÖ Hasil Cluster K-Means Final</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="final-results-table">
                                <thead>
                                    <tr>
                                        <th>Kategori</th>
                                        <th>Size Range</th>
                                        <th>Jumlah Terjual</th>
                                        <th>Cluster</th>
                                    </tr>
                                </thead>
                                <tbody id="final-results-tbody">
                                </tbody>
                            </table>
                        </div>

                        <h6 style="margin-top: 2rem; font-weight: 600;">üìà Ringkasan Cluster</h6>
                        <div class="summary-stats" id="summary-stats"></div>
                    </div>
                </div>
            </div>
        </div>


    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="{{ url_for('static', filename='js/preprocessing-kmeans.js') }}"></script>
{% endblock %}
