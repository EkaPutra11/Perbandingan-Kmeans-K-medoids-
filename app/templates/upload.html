{% extends 'base.html' %}

{% block title %}Upload Data - Arwana Sales Analytics{% endblock %}

{% block content %}
<style>
    .upload-container {
        max-width: 600px;
        margin: 50px auto;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
    }
    .file-input-label {
        display: block;
        padding: 15px;
        background: #007bff;
        color: white;
        text-align: center;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 15px;
        transition: background 0.3s;
    }
    .file-input-label:hover {
        background: #0056b3;
    }
    #fileInput {
        display: none;
    }
    .file-name {
        margin-top: 10px;
        font-size: 14px;
        color: #666;
    }
    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    .button-group button {
        flex: 1;
    }
    .stats {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 5px;
        display: none;
    }
    .stats.show {
        display: block;
    }
    .alert {
        margin-top: 15px;
    }
</style>

<div class="upload-container bg-white">
    <h2 class="mb-4 text-center">Upload Data CSV</h2>
            
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="file-input-wrapper">
                    <label for="fileInput" class="file-input-label">
                        üìÅ Pilih File CSV atau Drag & Drop di sini
                    </label>
                    <input type="file" id="fileInput" name="file" accept=".csv" required>
                </div>
                <div class="file-name" id="fileName"></div>

                <div class="button-group">
                    <button type="submit" class="btn btn-success btn-lg" id="uploadBtn">
                        <i class="bi bi-upload"></i> Upload
                    </button>
                    <button type="button" class="btn btn-warning btn-lg" id="deleteDataBtn" onclick="deleteAllData()">
                        <i class="bi bi-trash"></i> Hapus Data
                    </button>
                    <button type="button" class="btn btn-danger btn-lg" id="deleteResultsBtn" onclick="deleteAllResults()">
                        <i class="bi bi-trash"></i> Hapus Hasil
                    </button>
                </div>
            </form>

            <div id="alertContainer"></div>

            <div class="stats" id="stats">
                <h5>üìä Statistik Data</h5>
                <p><strong>Total Records:</strong> <span id="totalRecords">0</span></p>
                <p><strong>Kategori Standard:</strong> <span id="standardCount">0</span></p>
                <p><strong>Kategori Non-Standard:</strong> <span id="nonStandardCount">0</span></p>
                <p><strong>Total Size Unik:</strong> <span id="uniqueSize">0</span></p>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='bootstrap/bootstrap-5.3.8-dist/js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // File input handling
        const fileInput = document.getElementById('fileInput');
        const uploadForm = document.getElementById('uploadForm');
        const fileName = document.getElementById('fileName');

        fileInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                fileName.textContent = '‚úì File terpilih: ' + this.files[0].name;
            }
        });

        // Drag and drop
        const dropZone = document.querySelector('.file-input-label');
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.background = '#0056b3';
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.background = '#007bff';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.background = '#007bff';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileName.textContent = '‚úì File terpilih: ' + files[0].name;
            }
        });

        // Form submission
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                showAlert(data.status, data.message);

                if (data.status === 'success') {
                    fileInput.value = '';
                    fileName.textContent = '';
                    loadStatistics();
                }
            } catch (error) {
                showAlert('error', 'Upload failed: ' + error.message);
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = originalText;
            }
        });

        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const icon = type === 'success' ? '‚úì' : '‚úó';
            
            alertContainer.innerHTML = `
                <div class="alert alert-${alertClass === 'alert-success' ? 'success' : 'danger'} alert-dismissible fade show" role="alert">
                    <strong>${icon}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        async function loadStatistics() {
            try {
                const response = await fetch('/data/stats');
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalRecords').textContent = stats.total_records;
                    document.getElementById('standardCount').textContent = stats.standard_count;
                    document.getElementById('nonStandardCount').textContent = stats.non_standard_count;
                    document.getElementById('uniqueSize').textContent = stats.unique_sizes;
                    document.getElementById('stats').classList.add('show');
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        async function deleteAllData() {
            if (!confirm('‚ö†Ô∏è Apakah Anda yakin ingin menghapus SEMUA data? Tindakan ini tidak bisa dibatalkan!')) {
                return;
            }

            const deleteBtn = document.getElementById('deleteDataBtn');
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Menghapus...';

            try {
                const response = await fetch('/delete/data', { method: 'POST' });
                const data = await response.json();
                showAlert(data.status, data.message);
                
                if (data.status === 'success') {
                    document.getElementById('stats').classList.remove('show');
                    setTimeout(() => location.reload(), 1500);
                }
            } catch (error) {
                showAlert('error', 'Delete failed: ' + error.message);
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Hapus Data';
            }
        }

        async function deleteAllResults() {
            if (!confirm('‚ö†Ô∏è Apakah Anda yakin ingin menghapus SEMUA hasil clustering?')) {
                return;
            }

            const deleteBtn = document.getElementById('deleteResultsBtn');
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Menghapus...';

            try {
                const response = await fetch('/delete/results', { method: 'POST' });
                const data = await response.json();
                showAlert(data.status, data.message);
                
                if (data.status === 'success') {
                    setTimeout(() => location.reload(), 1500);
                }
            } catch (error) {
                showAlert('error', 'Delete failed: ' + error.message);
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = '<i class="bi bi-trash"></i> Hapus Hasil';
            }
        }

        // Load stats on page load
        window.addEventListener('load', loadStatistics);
    </script>
</div>
{% endblock %}
